<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f8ff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .navbar {
      background-color: #0d6efd;
    }
    .navbar-brand {
      color: #fff !important;
    }
    .container {
      margin-top: 30px;
      flex: 1;
    }
    .footer {
      background-color: #0d6efd;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      margin-top: auto;
    }
    .card {
      border: 1px solid #007bff;
      margin-bottom: 20px;
    }
    .correct-answer {
      display: none;
      font-weight: bold;
      margin-top: 10px;
    }
    .correct {
      color: green;
    }
    .incorrect {
      color: red;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">View Quiz</a>
    <button id="logoutBtn" class="btn btn-light">Logout</button>
  </div>
</nav>

<div class="container">
  <div class="card">
    <div class="card-header">
      <h4 id="quizTitle">Loading...</h4>
    </div>
    <div class="card-body" id="questionsArea">

    </div>
  </div>
</div>

<div class="footer">
  <p>&copy; 2025 Quiz App</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const quizId = "{{ quiz_id }}"; // Provided by Flask route
let accessToken = localStorage.getItem('accessToken');

if (!accessToken) {
  window.location.href = '/login';
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('accessToken');
  window.location.href = '/login';
});

// Load the quiz on page load
document.addEventListener('DOMContentLoaded', loadQuiz);

async function loadQuiz() {
  try {
    const resp = await fetch(`/quiz/${quizId}`, {
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    const data = await resp.json();

    if (!resp.ok) {
      alert(`Error: ${data.message ?? resp.statusText}`);
      return;
    }

    document.getElementById('quizTitle').textContent = data.title;

    const questionsArea = document.getElementById('questionsArea');
    questionsArea.innerHTML = '';

    data.questions.forEach((q, index) => {
      const div = document.createElement('div');
      div.className = 'mb-3 p-3 border rounded';

      div.innerHTML = `
        <h5>Question ${index + 1}</h5>
        <p><strong>${q.questionText}</strong></p>
        <select class="form-select answer-select" data-question="${q.questionText}">
          <option value="">Select an answer</option>
          ${q.options.map(option => `<option value="${option}">${option}</option>`).join('')}
        </select>
        <p class="correct-answer" id="correct-answer-${index}" style="display: none;"></p>
      `;
      questionsArea.appendChild(div);
    });

    attachAnswerCheckListeners();
  } catch (err) {
    alert(`Network error: ${err}`);
  }
}

// Attach event listeners to dropdowns
function attachAnswerCheckListeners() {
  document.querySelectorAll('.answer-select').forEach(select => {
    select.addEventListener('change', async function () {
      const selectedAnswer = this.value;
      const questionText = this.dataset.question;
      const correctAnswerElem = this.parentElement.querySelector('.correct-answer');

      if (selectedAnswer) {
        const result = await checkAnswer(questionText, selectedAnswer);

        if (result.correct) {
          correctAnswerElem.textContent = "Correct!";
          correctAnswerElem.className = "correct-answer correct";
        } else {
          correctAnswerElem.textContent = `Incorrect. The correct answer is: ${result.correctAnswer}`;
          correctAnswerElem.className = "correct-answer incorrect";
        }
        correctAnswerElem.style.display = "block";
      }
    });
  });
}

// Function to check the selected answer
// Function to check the selected answer
async function checkAnswer(question, selectedAnswer) {
  try {
    const resp = await fetch(`/quiz/${quizId}/answer`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ question, selected_answer: selectedAnswer.trim() }) // Trim spaces
    });

    const data = await resp.json();

    if (resp.ok && data.correct_answer) {
      return {
        correct: data.correct,
        correctAnswer: data.correct_answer
      };
    } else {
      console.error('Error:', data.message);
      return { correct: false, correctAnswer: 'Could not retrieve the correct answer' };
    }
  } catch (err) {
    console.error(`Error checking answer: ${err}`);
    return { correct: false, correctAnswer: 'Error occurred' };
  }
}
</script>
</body>
</html>